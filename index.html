<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>บันทึกกิจกรรมประจำวัน</title>

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4a90e2"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="บันทึกกิจกรรมประจำวัน">
  <link rel="apple-touch-icon" href="./192.png">

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container" style="padding:0; border:none; background:none;">
    
    <!-- ส่วนแนะนำการติดตั้งแอป -->
    <div id="install-guide" class="install-prompt">
      <span class="close-prompt" onclick="hideInstallPromptPermanently()">&times;</span>
      <h4>ติดตั้งแอปนี้ลงในเครื่องของคุณ!</h4>
      <ul>
        <li><b>สำหรับ Android:</b> เบราว์เซอร์ Chrome จะมีปุ่ม "ติดตั้งแอป" หรือ "เพิ่มไปยังหน้าจอหลัก" แสดงขึ้นมาให้กด</li>
        <li><b>สำหรับ iPhone (iOS):</b> เปิดใน Safari แล้วกดที่ปุ่ม "แชร์" (Share) จากนั้นเลือก "เพิ่มไปยังหน้าจอโฮม" (Add to Home Screen)</li>
      </ul>
      <div style="text-align: center; margin-top: 10px;">
        <button onclick="hideInstallPromptPermanently()" style="background-color: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
          ไม่แสดงข้อความนี้อีก
        </button>
      </div>
    </div>

    <!-- ส่วนหัวแอปพลิเคชัน -->
    <div style="text-align: center; margin-top: 5px;">
      <div class="container">
        <div style="width: 100%; max-width: 600px; margin: 10px auto;">
          <h1 style="text-align: center; color: blue; font-size: clamp(1.2rem, 4vw, 1.8rem);">
            บันทึกกิจกรรมประจำวัน
          </h1>
          
          <!-- ปุ่มกู้คืนข้อมูลที่ย้ายมาอยู่ด้านบน -->
          <div class="button-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
            <button 
              type="button" 
              onclick="document.getElementById('restoreFile').click()" 
              style="flex: 1; background-color: #ff69b4; color: white; font-weight: bold; padding: 10px; font-size: 1rem; border: none; border-radius: 50px; cursor: pointer;">
              โหลดข้อมูลที่บันทึกไว้
            </button>
            <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(this.files[0])">
          </div>
          
          <!-- เมนูใหญ่ 1: เพิ่มกิจกรรม -->
          <div class="section-header main-section-header header-add-data" onclick="toggleMainSection('add-activity-section')">
            <span>➕ เพิ่มกิจกรรม</span>
            <span class="menu-icon">▼</span>
          </div>
          <div id="add-activity-section" class="section-content main-section-content">
            <div class="form-section">
              <form id="activity-form">
                
                <!-- ส่วนจัดการผู้ทำกิจกรรมและประเภทกิจกรรม - ซ่อนเมนูย่อยแล้ว -->
                <div class="management-row compact-layout">
                  <!-- ส่วนจัดการผู้ทำกิจกรรม -->
                  <div class="management-container">
                    <div class="select-wrapper">
                      <button type="button" class="manage-btn-inline" onclick="toggleManagementActions('personActions')" title="จัดการผู้ทำกิจกรรม">⚙️</button>
                      <select id="personSelect" onchange="checkCustomOption(this)" required style="flex: 1;">
                        <option value="">-- เลือกผู้ทำกิจกรรม --</option>
                      </select>
                    </div>

                    <!-- ซ่อนเมนูย่อยการจัดการผู้ทำกิจกรรม -->
                    <div class="management-actions" id="personActions" style="display: none;">
                      <button type="button" id="addPersonBtn" class="add-btn">เพิ่ม</button>
                      <button type="button" id="editPersonBtn" class="edit-btn">แก้ไข</button>
                      <button type="button" id="deletePersonBtn" class="delete-btn">ลบ</button>
                      <button type="button" id="resetPersonBtn" class="reset-btn">คืนค่า</button>
                    </div>

                    <input type="text" id="customPersonInput" placeholder="กรุณากรอกชื่อผู้ทำกิจกรรมเอง" style="display: none; width: 100%; margin: 5px 0; padding: 8px;" />
                  </div>
                  
                  <!-- ส่วนจัดการประเภทกิจกรรม -->
                  <div class="management-container">
                    <div class="select-wrapper">
                      <button type="button" class="manage-btn-inline" onclick="toggleManagementActions('activityTypeActions')" title="จัดการประเภทกิจกรรม">⚙️</button>
                      <select id="activityTypeSelect" onchange="checkCustomActivityTypeOption(this)" required style="flex: 1;">
                        <option value="">-- เลือกประเภทกิจกรรม --</option>
                      </select>
                    </div>

                    <!-- ซ่อนเมนูย่อยการจัดการประเภทกิจกรรม -->
                    <div class="management-actions" id="activityTypeActions" style="display: none;">
                      <button type="button" id="addActivityTypeBtn" class="add-btn">เพิ่ม</button>
                      <button type="button" id="editActivityTypeBtn" class="edit-btn">แก้ไข</button>
                      <button type="button" id="deleteActivityTypeBtn" class="delete-btn">ลบ</button>
                      <button type="button" id="resetActivityTypeBtn" class="reset-btn">คืนค่า</button>
                    </div>

                    <input type="text" id="customActivityTypeInput" placeholder="กรุณากรอกประเภทกิจกรรมเอง" style="display: none; width: 100%; margin: 5px 0; padding: 8px;" />
                  </div>
                </div>
                
                <label for="activity-date">วันที่:</label>
                <input type="date" id="activity-date" required>
                
                <label for="start-time">เวลาเริ่มต้นและสิ้นสุด:</label>
                <div class="time-inputs-container">
                  <div class="time-input-group">
                    <input type="time" id="start-time" required>
                    <span class="time-label">เริ่ม</span>
                  </div>
                  <span class="time-separator">ถึง</span>
                  <div class="time-input-group">
                    <input type="time" id="end-time" required>
                    <span class="time-label">สิ้นสุด</span>
                  </div>
                </div>
                
                <label for="activity-details">รายละเอียดกิจกรรม (ไม่บังคับ):</label>
                <textarea id="activity-details" placeholder="เช่น การประชุมกับทีม, อ่านหนังสือบทที่ 5"></textarea>
                
                <button type="submit" id="save-activity-button">บันทึกกิจกรรม</button>
                <button type="button" id="update-activity-button" class="hidden">อัปเดตกิจกรรม</button>
                <button type="button" id="cancel-edit-activity-button" class="hidden">ยกเลิก</button>
                
                <p id="activity-message" class="error-message"></p>
              </form>
              
              <!-- ย้ายปุ่มแสดง/ซ่อนกิจกรรมทั้งหมดมาอยู่ที่นี่ -->
              <div class="button-container" style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" onclick="toggleActivitiesVisibility()" style="flex: 1; background-color: #607d8b;">แสดง/ซ่อนกิจกรรมทั้งหมด</button>
              </div>
            </div>
          </div>
        
          <!-- เมนูใหญ่ 2: จัดการกิจกรรม -->
          <div class="section-header main-section-header header-actions" onclick="toggleMainSection('manage-activities-section')">
            <span>⚙️ จัดการกิจกรรม</span>
            <span class="menu-icon">▼</span>
          </div>
          <div id="manage-activities-section" class="section-content main-section-content">
            
  <!-- ส่วนสำรองข้อมูลและกู้คืน -->
<div class="summary-subsection">
  <!-- เพิ่มส่วนแสดงสถานะรหัสผ่าน -->
  <div style="text-align: center; margin: 10px 0;">
    <p id="password-status" style="font-size: 0.9rem; color: #f5a623;">
      สถานะ: ยังไม่มีการตั้งรหัสผ่าน (ไฟล์สำรองจะไม่ถูกเข้ารหัส)
    </p>
  </div>
  <div class="entry-form" style="margin-bottom: 0;">
    <div class="button-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
      <button type="button" onclick="saveToLocal()" style="flex: 1; background-color: #17a2b8;">บันทึกชั่วคราว</button>
      <button type="button" onclick="openExportOptionsModal()" style="flex: 1; background-color: #0d47a1;">บันทึกข้อมูล</button>
    </div>
    
    <div class="entry-group">
      <label for="backup-password">รหัสผ่านสำรองข้อมูล (ไม่บังคับ):</label>
      <div style="position: relative;">
        <input type="password" id="backup-password" placeholder="ถ้าไม่ต้องการใช้รหัสผ่าน ให้ปล่อยว่างไว้" style="width: 100%; padding-right: 40px;">
        <span id="toggle-password" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; user-select: none;">👁️</span>
      </div>
    </div>
    <div class="entry-group">
      <label for="backup-password-confirm">ยืนยันรหัสผ่าน:</label>
      <div style="position: relative;">
        <input type="password" id="backup-password-confirm" placeholder="กรอกรหัสผ่านอีกครั้ง" style="width: 100%; padding-right: 40px;">
        <span id="toggle-password-confirm" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; user-select: none;">👁️</span>
      </div>
    </div>
    <div class="button-container" style="text-align: center; margin-top: 10px;">
      <button type="button" onclick="saveBackupPassword(event)" style="background-color: #28a745; margin-right: 10px;">
        ตั้งรหัสผ่าน
      </button>
      <button type="button" onclick="clearBackupPassword()" style="background-color: #dc3545;">
        ลบรหัสผ่าน
      </button>
    </div>
  </div>
</div>

            <!-- ส่วนจัดการข้อมูลและทำความสะอาด -->
            <div class="summary-subsection">
              <div class="button-container" style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                <button type="button" onclick="cleanAllData()" class="clean-data-btn" style="background-color: #ff5722; color: white;">
                  🧹 ทำความสะอาดข้อมูลทั้งหมด
                </button>
              </div>
              <p style="text-align: center; font-size: 0.9rem; color: #666; margin-top: 5px;">
                ตรวจสอบสุขภาพข้อมูล, ลบข้อมูลซ้ำ, กิจกรรมขยะ และไฟล์ที่ไม่จำเป็น
              </p>
            </div>
          </div> <!-- ปิด div ของเมนูจัดการกิจกรรม -->
     
          <!-- เมนูใหญ่ 3: สรุปกิจกรรม -->
          <div class="section-header main-section-header header-summary" onclick="toggleMainSection('summary-section')">
            <span>📊 สรุปกิจกรรม</span>
            <span class="menu-icon">▼</span>
          </div>
          <div id="summary-section" class="section-content main-section-content">
            
            <!-- เมนูเลือกประเภทการสรุป -->
            <div class="summary-subsection">
              <div class="entry-form" style="margin-bottom: 0;">
                <div class="entry-group">
                  <label for="summary-type-select">ประเภทการสรุป:</label>
                  <select id="summary-type-select" onchange="loadSummaryData()">
                    <option value="brief-summary">สรุปอย่างย่อ</option>
                    <option value="single-day">ตามวันที่เลือก</option>
                    <option value="date-range">ตามช่วงวันที่</option>
                    <option value="all-time">ทั้งหมด</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- ส่วนกรองผู้ทำกิจกรรม -->
            <div class="summary-controls">
              <!-- ส่วนแสดงผู้ทำกิจกรรมอัตโนมัติ (แสดงเมื่อมีแค่คนเดียว) -->
              <div class="auto-selected-person" id="autoSelectedPerson" style="display: none; background-color: #f8f9fa; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6; margin-bottom: 10px;">
                <label style="font-weight: bold; margin-right: 8px; color: #495057;">ผู้ทำกิจกรรม:</label>
                <span id="selectedPersonName" style="color: #28a745; font-size: 1rem; font-weight: bold;"></span>
              </div>

              <!-- Dropdown กรองผู้ทำกิจกรรม (แสดงเมื่อมีหลายคน) -->
              <div class="person-filter-container" id="personFilterContainer">
                <label for="personFilter">ผู้ทำกิจกรรม:</label>
                <select id="personFilter" onchange="loadSummaryData()">
                  <option value="all">ทุกคน</option>
                </select>
              </div>
            </div>
            
            <!-- ฟิลด์วันที่ (จะแสดง/ซ่อนตามประเภทที่เลือก) -->
            <div id="summary-date-picker" class="summary-subsection hidden">
              <label class="summary-subsection-header">เลือกวันที่</label>
              <div class="entry-form" style="margin-bottom: 0;">
                <div class="entry-group">
                  <label for="summary-date">เลือกวันที่:</label>
                  <input type="date" id="summary-date">
                </div>
              </div>
            </div>
            
            <div id="summary-date-range" class="summary-subsection hidden">
              <label class="summary-subsection-header">เลือกช่วงวันที่</label>
              <div class="entry-form" style="margin-bottom: 0;">
                <div class="entry-group">
                  <label for="summary-start-date">จากวันที่:</label>
                  <input type="date" id="summary-start-date">
                </div>
                <div class="entry-group">
                  <label for="summary-end-date">ถึงวันที่:</label>
                  <input type="date" id="summary-end-date">
                </div>
              </div>
            </div>
            
            <!-- ปุ่มดูสรุป -->
            <div class="summary-subsection">
              <div class="button-container" style="text-align: center; margin-top: 10px;">
                <button type="button" onclick="viewSummary()" style="background-color: #673ab7; color: #FFFFFF;">ดูสรุป</button>
              </div>
            </div>
          </div> <!-- ปิด div ของเมนูสรุปกิจกรรม -->
          
          <!-- ตารางกิจกรรม - ปรับปรุงให้เป็น Responsive -->
          <div id="activitiesSection" style="display: none; margin-top: 20px; width: 100%;">
            <div class="table-container">
              <table id="activityTable">
                <thead>
                  <tr>
                    <th>วันเดือนปี</th>
                    <th>เวลาเริ่มต้น</th>
                    <th>ผู้ทำกิจกรรม</th>
                    <th>ประเภทกิจกรรม</th>
                    <th>ระยะเวลา</th>
                    <th>รายละเอียด</th>
                    <th>การจัดการ</th>
                  </tr>
                </thead>
                <tbody id="activityBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- โครงสร้าง Popup สำหรับแสดงผลสรุป -->
    <div id="summaryModal" class="modal-overlay">
      <div class="modal-content-container">
        <div id="modalBodyContent" class="summaryResult">
          <!-- เนื้อหาการสรุปจะถูกใส่ที่นี่โดย JavaScript -->
        </div>
        <div class="modal-controls">
          <button id="saveSummaryAsImageBtn" class="modal-control-btn">บันทึกเป็นรูปภาพ</button>
          <button type="button" onclick="closeSummaryModal()" class="modal-close-btn modal-control-btn">ปิดหน้าต่างนี้</button>
        </div>
      </div>
    </div>

    <!-- Modal สำหรับเลือกรูปแบบการแสดงผลสรุป -->
    <div id="summaryOutputModal" class="modal-overlay">
      <div class="format-modal-content">
        <h3>เลือกรูปแบบการแสดงผลสรุป</h3>
        <div class="format-modal-buttons">
          <button type="button" class="btn-display" onclick="handleSummaryOutput('display')">แสดงบนจอ</button>
          <button type="button" class="btn-xlsx" onclick="handleSummaryOutput('xlsx')">บันทึกเป็น XLSX</button>
          <button type="button" class="btn-pdf" onclick="handleSummaryOutput('pdf')">บันทึกเป็น PDF</button>
          <button type="button" class="btn-cancel" onclick="closeSummaryOutputModal()">ยกเลิก</button>
        </div>
      </div>
    </div>

    <!-- Modal สำหรับจัดการผู้ทำกิจกรรม -->
    <div id="personModal" class="popup-overlay">
      <div class="popup-content" style="max-width: 400px; background-color: #f0f8ff;">
        <h2 id="personModalTitle" style="color: #0056b3; text-align: center;"></h2>
        <input type="hidden" id="personEditValue">
        <input type="text" id="modalPersonName" placeholder="ชื่อผู้ทำกิจกรรม">
        <div class="modal-button-group">
          <button type="button" id="savePersonBtn" style="background-color: #28a745;">บันทึก</button>
          <button type="button" id="cancelPersonBtn" class="close-popup-btn">ยกเลิก</button>
        </div>
      </div>
    </div>

    <!-- Modal สำหรับจัดการประเภทกิจกรรม -->
    <div id="activityTypeModal" class="popup-overlay">
      <div class="popup-content" style="max-width: 400px; background-color: #f0f8ff;">
        <h2 id="activityTypeModalTitle" style="color: #0056b3; text-align: center;"></h2>
        <input type="hidden" id="activityTypeEditValue">
        <input type="text" id="modalActivityTypeName" placeholder="ชื่อประเภทกิจกรรม">
        <div class="modal-button-group">
          <button type="button" id="saveActivityTypeBtn" style="background-color: #28a745;">บันทึก</button>
          <button type="button" id="cancelActivityTypeBtn" class="close-popup-btn">ยกเลิก</button>
        </div>
      </div>
    </div>

    <!-- Container สำหรับพิมพ์ PDF -->
    <div id="print-container" style="display: none;"></div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification" style="display: none;"></div>

    <!-- Modal สำหรับเลือกประเภทการบันทึกข้อมูล -->
    <div id="exportOptionsModal" class="modal-overlay">
      <div class="format-modal-content">
        <h3>เลือกประเภทการบันทึกข้อมูล</h3>
        <div class="format-modal-buttons">
          <button onclick="saveToFile()" style="background-color: #0d47a1;">บันทึกข้อมูลทั้งหมด (ทุกบัญชี)</button>
          <button onclick="exportSelectedAccount()" style="background-color: #ff9800;">บันทึกบัญชีที่เลือก (ทั้งหมด)</button>
          <button onclick="initiateSingleDateExport()" style="background-color: #009688;">บันทึกเฉพาะวันที่เลือก (บัญชีนี้)</button>
          <button class="btn-cancel" onclick="closeExportOptionsModal()">ยกเลิก</button>
        </div>
      </div>
    </div>

<!-- Modal เลือกวันที่ (สำหรับบันทึกรายวัน) - แบบใหม่ -->
<div id="singleDateExportModal" class="modal-overlay">
  <div class="format-modal-content">
    <h3>เลือกช่วงวันที่ต้องการบันทึก</h3>
    <p>ข้อมูลจากบัญชี: <strong id="singleDateAccountName"></strong></p>
    
    <div class="entry-form" style="margin-bottom: 20px;">
      <div class="entry-group">
        <label for="exportStartDate">จากวันที่:</label>
        <input type="date" id="exportStartDate" required>
      </div>
      <div class="entry-group">
        <label for="exportEndDate">ถึงวันที่:</label>
        <input type="date" id="exportEndDate" required>
      </div>
    </div>
    
    <div class="format-modal-buttons">
      <button class="btn-display" onclick="processDateRangeExport()">บันทึกข้อมูล</button>
      <button class="btn-cancel" onclick="closeSingleDateExportModal()">ยกเลิก</button>
    </div>
  </div>
</div>
  </div>
  <!-- JavaScript -->
  <script src="script.js"></script>
  <script>
    // ลงทะเบียน Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js')
          .then(function(registration) {
            console.log('Service Worker ลงทะเบียนสำเร็จ: ', registration.scope);
          })
          .catch(function(error) {
            console.log('Service Worker ลงทะเบียนล้มเหลว: ', error);
          });
      });
    }

    // ตรวจสอบว่ามีการอัพเดท Service Worker หรือไม่
    navigator.serviceWorker.addEventListener('controllerchange', function() {
      console.log('Service Worker ถูกอัพเดทแล้ว');
      window.location.reload();
    });
    
    // ฟังก์ชันสำหรับการจัดการแบบมือถือ
    function toggleMobileManagement(actionsId) {
      const actions = document.getElementById(actionsId);
      if (actions.style.display === 'flex') {
        actions.style.display = 'none';
      } else {
        actions.style.display = 'flex';
      }
    }
    
    // อัพเดทฟังก์ชัน checkCustomOption และ checkCustomActivityTypeOption
    function checkCustomOption(selectElement) {
      const customInput = document.getElementById('customPersonInput');
        
      if (selectElement.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }
    }
    
    function checkCustomActivityTypeOption(selectElement) {
      const customInput = document.getElementById('customActivityTypeInput');
        
      if (selectElement.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }
    }
    
    // อัพเดทฟังก์ชัน toggleManagementActions สำหรับเดสก์ท็อป
    function toggleManagementActions(showId) {
      const showElement = document.getElementById(showId);
      
      if (showElement.style.display === 'flex') {
        showElement.style.display = 'none';
      } else {
        showElement.style.display = 'flex';
      }
    }
    
    // ฟังก์ชันสำหรับแสดง/ซ่อนกิจกรรมทั้งหมด
    function toggleActivitiesVisibility() {
      const activitiesSection = document.getElementById('activitiesSection');
      if (activitiesSection.style.display === 'none') {
        activitiesSection.style.display = 'block';
        loadUserActivities();
      } else {
        activitiesSection.style.display = 'none';
      }
    }
  </script>
</body>
</html>