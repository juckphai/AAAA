// === ฟังก์ชันสำหรับการพิมพ์ PDF ที่ปรับปรุงแล้ว ===
// === ฟังก์ชันสำหรับการพิมพ์ PDF ที่ปรับปรุงแล้ว (ไม่ใช้ popup) ===
function exportSummaryToPDF() {
    const { type, activities, startDate, endDate, personFilter } = summaryContext;
    
    if (!activities || activities.length === 0) {
        alert('ไม่มีข้อมูลกิจกรรมสำหรับสร้าง PDF');
        return;
    }
    
    // ✅ ตรวจสอบว่ามีผู้ทำกิจกรรมแค่คนเดียวในระบบหรือไม่
    const allPersons = getFromLocalStorage('persons') || [];
    let actualPersonFilter = personFilter;
    if (allPersons.length === 1 && personFilter === 'all') {
        actualPersonFilter = allPersons[0].name;
    }
    
    const personSummaryText = actualPersonFilter !== 'all' 
        ? `สรุปกิจกรรมของ: ${actualPersonFilter}` 
        : 'สรุปกิจกรรมของ: ทุกคน';

    // คำนวณข้อมูลสรุป
    const totalDurationAll = activities.reduce((total, activity) => {
        return total + calculateDuration(activity.startTime, activity.endTime);
    }, 0);
    
    // จัดกลุ่มกิจกรรมตามประเภท
    const typeTotals = {};
    activities.forEach(activity => {
        const duration = calculateDuration(activity.startTime, activity.endTime);
        if (!typeTotals[activity.activityName]) {
            typeTotals[activity.activityName] = 0;
        }
        typeTotals[activity.activityName] += duration;
    });
    
    // คำนวณจำนวนวันที่มีกิจกรรม
    const activityDates = [...new Set(activities.map(activity => activity.date))];
    const daysWithActivities = activityDates.length;

    // ========== เพิ่มส่วนคำนวณวันที่ไม่มีกิจกรรม ==========
    let totalDays = 0;
    let daysWithoutActivities = 0;

    if (startDate && endDate) {
        // กรณีมีช่วงวันที่
        const start = new Date(startDate);
        const end = new Date(endDate);
        totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        daysWithoutActivities = totalDays - daysWithActivities;
    } else if (startDate) {
        // กรณีวันเดียว
        totalDays = 1;
        daysWithoutActivities = daysWithActivities > 0 ? 0 : 1;
    } else {
        // กรณีทั้งหมด (ใช้ช่วงเวลาของข้อมูลที่มี)
        if (activityDates.length > 0) {
            const sortedDates = activityDates.sort();
            const firstDate = new Date(sortedDates[0]);
            const lastDate = new Date(sortedDates[sortedDates.length - 1]);
            totalDays = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;
            daysWithoutActivities = totalDays - daysWithActivities;
        } else {
            totalDays = 0;
            daysWithoutActivities = 0;
        }
    }
    
    // คำนวณค่าเฉลี่ยต่อวัน
    const avgDurationPerDay = daysWithActivities > 0 ? totalDurationAll / daysWithActivities : 0;
    
    // กำหนดช่วงวันที่
    let dateRangeText = '';
    if (startDate && endDate) {
        if (startDate === endDate) {
            dateRangeText = `สรุปของวันที่ ${formatDateForDisplay(startDate)}`;
        } else {
            dateRangeText = `ช่วงวันที่ ${formatDateForDisplay(startDate)} ถึง ${formatDateForDisplay(endDate)}`;
        }
    } else if (startDate) {
        dateRangeText = `สรุปของวันที่ ${formatDateForDisplay(startDate)}`;
    } else {
        const allDates = activityDates.sort();
        if (allDates.length > 0) {
            if (allDates[0] === allDates[allDates.length - 1]) {
                dateRangeText = `สรุปของวันที่ ${formatDateForDisplay(allDates[0])}`;
            } else {
                dateRangeText = `จากวันที่ ${formatDateForDisplay(allDates[0])} ถึง ${formatDateForDisplay(allDates[allDates.length - 1])}`;
            }
        } else {
            dateRangeText = 'ไม่มีกิจกรรมในช่วงที่เลือก';
        }
    }
    
    // ตั้งชื่อไฟล์ PDF ให้มีเวลาพ่วงท้าย (ใช้ปี พ.ศ.)
    const now = new Date();
    const thaiYear = now.getFullYear() + 543;
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    
    const timestamp = `${day}${month}${thaiYear}_${hours}${minutes}`;
    const fileName = `สรุปกิจกรรม-${timestamp}.pdf`;

    // สร้าง HTML สำหรับพิมพ์ - ปรับให้เหมือนในหน้าจอทุกประการ
    let printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${personSummaryText}</title>
            <meta charset="UTF-8">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 10mm 3mm 5mm 8mm;
                    padding: 0;
                    color: #000;
                    line-height: 1.0;
                    font-size: 7px;
                    text-align: center;
                    background-color: #FAFAD2;
                }
                
                .summary-container {
                    width: 100%;
                    margin: 0 auto;
                    padding: 2px;
                    border: 1px solid #F660EB;
                    border-radius: 8px;
                    background-color: #FAFAD2;
                    text-align: center;
                    line-height: 1.0;
                }
                
                .header-section { 
                    text-align: center; 
                    margin-bottom: 1px;
                    padding-bottom: 0.5px;
                    border-bottom: 0.5px solid #F660EB;
                }
                
                .header-section h3 { 
                    color: blue; 
                    font-size: 0.7rem; 
                    line-height: 1.0; 
                    margin: 0.5px 0;
                }
                
                .summary-section {
                    background-color: #FAFAD2;
                    padding: 1px;
                    margin: 1px 0;
                    text-align: center;
                    color: blue;
                }
                
                .summary-section h4 {
                    margin: 1px 0;
                    font-size: 0.7rem;
                    line-height: 1.0;
                    color: blue;
                }
                
                .day-summary-line {
                    margin: 1px 0;
                    font-size: 0.65rem;
                    line-height: 1.0;
                    color: blue;
                }

                /* ===== ตารางแบบกะทัดรัด ===== */
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 2px 0;
                    font-size: 0.6rem;
                    table-layout: fixed;
                }
                
                th { 
                    background-color: #007bff;
                    color: white;
                    padding: 1px;
                    border: 0.5px solid #ddd;
                    text-align: center;
                    font-size: 0.6rem;
                    font-weight: normal;
                    height: 8px;
                }
                
                td { 
                    padding: 1px;
                    border: 0.5px solid #ddd;
                    text-align: center;
                    font-size: 0.55rem;
                    line-height: 1.0;
                    height: 7px;
                }

                /* ตั้งค่าหน้ากระดาษ */
                @page {
                    margin: 1mm;
                    size: A4;
                }

                /* ตารางแบบกะทัดรัดมากสำหรับกิจกรรมทั้งหมด */
                .super-compact-table {
                    font-size: 0.5rem;
                }
                
                .super-compact-table th,
                .super-compact-table td {
                    padding: 0.5px;
                    font-size: 0.5rem;
                    height: 6px;
                }

                /* ปรับความกว้างคอลัมน์ให้พอดี */
                .col-activity { width: 22%; }
                .col-date { width: 12%; }
                .col-time { width: 18%; }
                .col-duration { width: 13%; }
                .col-details { width: 35%; }
                
                .col-type { width: 60%; }
                .col-total { width: 40%; }

                /* ควบคุมการแบ่งหน้า */
                .no-break {
                    page-break-inside: avoid;
                }
            </style>
        </head>
        <body>
            <div class="summary-container">
                <!-- ส่วนหัวเหมือนในหน้าจอ -->
                <div class="header-section no-break">
                    <h3>${personSummaryText}</h3>
                    <h3>สรุปวันที่ ${getCurrentDateTimeThai().replace(/(\d{2}\/\d{2}\/\d{4}) (\d{2}:\d{2})/, '$1 เวลา $2 น.')}</h3>
                    <h3>${dateRangeText}</h3>
                </div>

                <!-- ส่วนสรุปจำนวนวัน -->
                <div class="summary-section no-break">
                    <h4>สรุปจำนวนวัน</h4>
                    <div class="day-summary">
                        <div class="day-summary-line">• จำนวนวันทั้งหมด: ${totalDays} วัน</div>
                        <div class="day-summary-line">• จำนวนวันที่มีกิจกรรม: ${daysWithActivities} วัน</div>
                        <div class="day-summary-line">• วันที่ไม่มีกิจกรรม: ${daysWithoutActivities} วัน</div>
                        <div class="day-summary-line">• เวลาเฉลี่ยต่อวัน: ${formatDuration(avgDurationPerDay)}</div>
                        <div class="day-summary-line">• รวมเวลาทั้งหมด: ${formatDuration(totalDurationAll)}</div>
                    </div>
                </div>

                <!-- ส่วนสรุปตามประเภทกิจกรรม -->
                <div class="no-break">
                    <h4 style="color: #0056b3; margin: 1px 0; font-size: 0.7rem;">
                        สรุปตามประเภทกิจกรรม
                    </h4>
                    <table>
                        <thead>
                            <tr>
                                <th class="col-type">ประเภทกิจกรรม</th>
                                <th class="col-total">ระยะเวลารวม</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // เพิ่มแถวข้อมูลประเภทกิจกรรม
    Object.entries(typeTotals).forEach(([type, duration]) => {
        printHTML += `
            <tr>
                <td class="col-type">${type}</td>
                <td class="col-total">${formatDuration(duration)}</td>
            </tr>
        `;
    });
    
    printHTML += `
                        </tbody>
                    </table>
                </div>
    `;
    
    // สำหรับสรุปอย่างย่อ
    if (type === 'brief-summary') {
        printHTML += `
            <div class="no-break">
                <h4 style="color: #0056b3; margin: 1px 0; font-size: 0.7rem;">
                    กิจกรรมล่าสุด (15 รายการ)
                </h4>
                <table>
                    <thead>
                        <tr>
                            <th class="col-activity">กิจกรรม</th>
                            <th class="col-date">วันที่</th>
                            <th class="col-time">เวลาเริ่ม&สิ้นสุด</th>
                            <th class="col-duration">รวมเวลา</th>
                            <th class="col-details">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        const latestActivities = [...activities]
            .sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.startTime.localeCompare(a.startTime);
            })
            .slice(0, 15);

        latestActivities.forEach(activity => {
            const duration = calculateDuration(activity.startTime, activity.endTime);
            printHTML += `
                <tr>
                    <td class="col-activity">${activity.activityName}</td>
                    <td class="col-date">${formatDateForDisplay(activity.date)}</td>
                    <td class="col-time">${activity.startTime} - ${activity.endTime}</td>
                    <td class="col-duration">${formatDuration(duration)}</td>
                    <td class="col-details">${activity.details || '-'}</td>
                </tr>
            `;
        });

        printHTML += `
                    </tbody>
                </table>
            </div>
        `;
    } else {
        // สำหรับสรุปแบบเต็ม - ใช้ตารางแบบกะทัดรัดมาก
        printHTML += `
            <div class="no-break">
                <h4 style="color: #0056b3; margin: 1px 0; font-size: 0.7rem;">
                    รายการกิจกรรมทั้งหมด (${activities.length} รายการ)
                </h4>
                <table class="super-compact-table">
                    <thead>
                        <tr>
                            <th class="col-activity">กิจกรรม</th>
                            <th class="col-date">วันที่</th>
                            <th class="col-time">เวลาเริ่ม&สิ้นสุด</th>
                            <th class="col-duration">รวมเวลา</th>
                            <th class="col-details">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        const sortedActivities = [...activities].sort((a, b) => {
            const dateCompare = b.date.localeCompare(a.date);
            if (dateCompare !== 0) return dateCompare;
            return b.startTime.localeCompare(a.startTime);
        });

        sortedActivities.forEach(activity => {
            const duration = calculateDuration(activity.startTime, activity.endTime);
            // ย่อรายละเอียดถ้ายาวเกินไป
            const shortDetails = activity.details && activity.details.length > 30 
                ? activity.details.substring(0, 30) + '...' 
                : (activity.details || '-');
                
            printHTML += `
                <tr>
                    <td class="col-activity">${activity.activityName}</td>
                    <td class="col-date">${formatDateForDisplay(activity.date)}</td>
                    <td class="col-time">${activity.startTime} - ${activity.endTime}</td>
                    <td class="col-duration">${formatDuration(duration)}</td>
                    <td class="col-details">${shortDetails}</td>
                </tr>
            `;
        });

        printHTML += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    printHTML += `
            </div>
            <div style="font-size: 5px; margin-top: 1px; text-align: center;">
                สร้างเมื่อ: ${new Date().toLocaleDateString('th-TH')} - ระบบบันทึกกิจกรรม
            </div>
        </body>
        </html>
    `;
    
    // วิธีที่ 1: พิมพ์โดยตรงในหน้าเดิม (ไม่ใช้ popup)
    try {
        // สร้าง iframe แทนการใช้ window.open
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(printHTML);
        iframeDoc.close();
        
        // พิมพ์หลังจากโหลดเนื้อหาเสร็จ
        setTimeout(() => {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            
            // ลบ iframe หลังจากพิมพ์เสร็จ
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 1000);
            
        }, 500);
        
        showToast('กำลังเตรียมพิมพ์ PDF...', 'success');
        
    } catch (error) {
        console.error('Error printing PDF:', error);
        
        // วิธีที่ 2: ใช้วิธีพิมพ์ธรรมดาในกรณีที่วิธีแรกไม่ทำงาน
        try {
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(printHTML);
                printWindow.document.close();
                printWindow.print();
            } else {
                // วิธีที่ 3: แสดง HTML ในหน้าเดิมและพิมพ์
                const printSection = document.createElement('div');
                printSection.innerHTML = printHTML;
                printSection.style.position = 'fixed';
                printSection.style.top = '0';
                printSection.style.left = '0';
                printSection.style.width = '100%';
                printSection.style.height = '100%';
                printSection.style.zIndex = '9999';
                printSection.style.backgroundColor = 'white';
                printSection.style.overflow = 'auto';
                
                document.body.appendChild(printSection);
                
                setTimeout(() => {
                    window.print();
                    setTimeout(() => {
                        document.body.removeChild(printSection);
                    }, 100);
                }, 500);
            }
        } catch (fallbackError) {
            console.error('Fallback printing also failed:', fallbackError);
            alert('ไม่สามารถพิมพ์ PDF ได้ กรุณาตรวจสอบการตั้งค่าป้องกันป๊อปอัพของเบราว์เซอร์');
        }
    }
}
// ฟังก์ชันเสริมสำหรับการพิมพ์ PDF
function getCurrentDateTimeThai() {
    const now = new Date();
    const thaiYear = now.getFullYear() + 543;
    const day = now.getDate().toString().padStart(2, '0');
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    
    return `${day}/${month}/${thaiYear} ${hours}:${minutes}`;
}